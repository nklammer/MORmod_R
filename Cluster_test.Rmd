---
title: "Cluster test"
author: "Noah Klammer"
date: "4/16/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Perform clustering analysis on pump circulation patterns

```{r}

load("BothSeasons_Processed.Rda")
library(cluster)
library(pvclust)
```

## For cluster analysis of circulation patterns, combine train and test sets

```{r}
circ_1_opt_train=c(circ_1_opt_train_swing,circ_1_opt_train_cool)
circ_1_opt_test=c(circ_1_opt_test_swing,circ_1_opt_test_cool)
circ_1_vector=c(circ_1_opt_train,circ_1_opt_test)
```

## Break the set out into ndays x nmodes (3-hour blocks of the day) matrix for clustering

```{r}
nmodes = 8
ndays = length(circ_1_vector)/24
idx = seq(from=3,to=24,by=3)
circ_1 = as.data.frame(matrix(nrow=ndays,ncol=nmodes))
daynames = vector(length=ndays)
modnames = c("M1","M2","M3","M4","M5","M6","M7","M8")

for(i in 1:ndays){
	circ_1[i,] = circ_1_vector[idx+(i-1)*24]
	daynames[i] = paste("Day ",i, sep="")
}

names(circ_1)=modnames
row.names(circ_1)=daynames
```

# Take a pass with K-Means Clusters

## K-Means diagnostics for number of clusters

```{r}
# wss within-cluster sum of squared errors

wss = (nrow(circ_1)-1)*sum(apply(circ_1,2,var))
for (i in 2:30) wss[i] = sum(kmeans(circ_1,centers=i)$withinss)
plot(1:30,wss,type="b",main="K-Means Cluster Diagonstics",
     xlab="Number of Clusters",ylab="Within Group SS")

```

## Let's use 6 clusters as a reasonable starting point

```{r}
nclust = 6
clust1_kmeans = kmeans(circ_1,centers=nclust)
centers = matrix(nrow=nclust, ncol=nmodes)

```

## Plot the clusters

```{r}
par(mfrow=c(2,ceiling(nclust/2)))
for(i in 1:nclust){
	idx = clust1_kmeans$cluster == i
	clustervals = as.matrix(circ_1[idx,])
	centers[i,] = clust1_kmeans$centers[i,]
	n = clust1_kmeans$size[i]
	plot(clustervals[1,],type="l",xlab="Building Modes",
	     ylab="PWM Value",col="gray",ylim=c(0,60),main=paste("Cluster ",i,sep=""))
	for(j in 2:n){
		lines(clustervals[j,],typ="l",col="gray")
	}
	lines(centers[i,],typ="l",col="black",lty="solid")
	text(2,58,paste("n = ",n,sep=""))
}
legend(x="topright",legend=c("Members","Center"),
       col=c("gray","black"),lty=c("solid","solid"),bty="n",bg="white",cex=0.8)

```

## Export the classes and centers of clusters, set to match the ndays in input

```{r eval=FALSE, include=FALSE}
circ_1_classes = clust1_kmeans$cluster
circ_1_centers = clust1_kmeans$centers
save(list=c("circ_1_classes","circ_1_centers"),
     file=paste("controlDataClusters_n", nclust,sep=""))

```


<br><br><br>