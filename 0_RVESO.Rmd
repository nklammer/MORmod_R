---
title: "Process ReadVarsESO csv"
author: "Noah Klammer"
date: "3/15/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

## Clear global and report

```{r}
rm(list = ls())
gc()
```


# Import

## ESO timeseries

```{r import, message=FALSE, warning=FALSE}
eplusout <- readr::read_csv("eplusout.csv")
```


```{r include=FALSE}
# readr::spec(eplusout)
freq <- "null"
rows <- nrow(eplusout) 
if (rows==8760*4) {
  freq <- "15 minutes"
} else if (rows==8760) {
  freq <- "hourly"
} else if (rows==12) {
  freq <- "monthly"
} else {freq <- "could not determine"}
```
There are ``r ncol(eplusout)`` column variables in this file with names like ``r names(eplusout)[3]``, ``r names(eplusout)[50]``, and ``r names(eplusout)[100]``.

The frequency of this .eso file's timestep is ``r freq``.

## Ideal Air Loads to Zone mapping

```{r message=FALSE, warning=FALSE}
library(readr)
IdLoAiSy_Map <- read_csv("IdLoAiSy-Map.csv")
# char list of unconditioned spaces
unc_zones <- IdLoAiSy_Map$`Zone List`[is.na(IdLoAiSy_Map$`Ideal Air Loads System Number`)]
# drop unconditioned spaces
ILAS_map <- IdLoAiSy_Map %>%
  na.omit() %>%
  arrange(`Ideal Air Loads System Number`)
# note that some conditioned spaces don't have heat/cool loads
# in this model
```
Unconditioned zones in this model are ``r unc_zones``

## Area to Zone mapping

```{r message=FALSE, warning=FALSE}
Area_Map <- read_csv("ZoneFloorArea-Map.csv")
```


### Get all var names that match "Sensible" && "Zone Ideal Loads"
```{r}
# stringr::str_view_all(names(eplusout),"Zone\\sIdeal\\sLoads+.+Sensible")
ILAS_col <- grep("Zone\\sIdeal\\sLoads+.+Sensible", 
                 names(eplusout), value = TRUE) 
```

*Done* There are ``r length(ILAS_col)`` column variables in this subset.

### Sort
```{r}
# sort and fix "10" < "2" with stringr
sorted_list <- stringr::str_sort(ILAS_col, numeric = TRUE)
ILAS <- eplusout[sorted_list]

```


### Replace Air System Number with Zone name

`stringr::str_view_all` html snippet very helpful. As is stringr cheatsheet pdf.

```{r}
library(stringr)
# looks at colnames for any digit sets and replaces with zone list mapping

# have to write which() indexing function
# and sapply over num vector
idx_n <- function(num) {
  which(num==ILAS_map$`Ideal Air Loads System Number`)
  }

s2nlist <- as.numeric(str_extract(colnames(ILAS),"[0-9]+"))
idx <- sapply(s2nlist,idx_n)

# str_replace() analogous to sub()
colnames(ILAS) =
stringr::str_replace(string = colnames(ILAS), 
                     pattern = "[0-9]+", 
                     replacement = ILAS_map$`Zone List`[idx])

# may have to do colname sort and re-index

# lessen characters in colnames
# ~Zone Ideal Loads Zone Sensible\\s~
colnames(ILAS) =
stringr::str_replace(colnames(ILAS), 
                     "\\:\\D{31}",
                     ": ")
```

### Normalize Loads by Floor Area

```{r}
# check here if var names ever change
# colnames(ILAS)

idx_s <- function(str) {
  which(str==Area_Map$`Zone List`)
  }

slist <- str_extract(colnames(ILAS),"(?<=SYSTEM\\s).+(?=\\:)")
idx2 <- sapply(slist,idx_s)
vec <- Area_Map$`Space Area [m2]`[idx2]

# apply normalization vector across matrix
ILAS <- sweep(ILAS, 2, vec, FUN = "/")

# change colnames to reflect metric
# **[J]** => [J/m^2]
colnames(ILAS) <- str_replace(colnames(ILAS),"(?<=\\[)J{1}","J/m^2")
```


### Inspect Zones and select only residential zones of interest

Residential zones are considered dwelling units, stairwells (don't know if they're connected vertically), and corridors above the first floor.

```{r}
res_list <- 
c(
grep("STAIRWELL_\\d", colnames(ILAS), value = TRUE),
grep("CORRIDOR_\\d", colnames(ILAS), value = TRUE),  
grep("BDRM", colnames(ILAS), value = TRUE)
)

sorted_list <- stringr::str_sort(res_list, numeric = TRUE)

ILAS <- ILAS[sorted_list]
```


### add Date/Time back in
```{r}
`Date/Time` <- eplusout$`Date/Time`
ILAS <- cbind(`Date/Time`,ILAS)

# make `Date/Time` string rownames
# this comes in handy for dataframe transpose
# drop hh:mm~:ss~
rownames(ILAS) <- str_replace(eplusout$`Date/Time`,".{3}$","")

# separate the date and time into cols month, day, hour, minute
ILAS <- ILAS %>%
  mutate(month = as.integer(substr(`Date/Time`, start = 0, stop = 2)),
         day = as.integer(substr(`Date/Time`, start = 4, stop = 5)),
         hour = as.integer(substr(`Date/Time`, start = 8, stop = 9)),
         `Date/Time` = as.integer(substr(`Date/Time`, start = 11, stop = 12))) %>%
  rename(minute = `Date/Time`)

sorted_list <- stringr::str_sort(colnames(ILAS), numeric = TRUE)

ILAS <- ILAS[sorted_list]
# numeric month var to month string
# ILAS <- transform(ILAS, month = month.abb[month])

# remove NA observations
ILAS <- ILAS %>% na.omit()
# remove the automatic row numbers
# rownames(ILAS) <- NULL
```
*Done* The variables of interest have been selected and observations of NA have been removed. The dataframe now has ``r ncol(ILAS)`` columns and ``r nrow(ILAS)`` rows.

### TODO - save as .Rda file

```{r}
save(ILAS,file = "ILAS.Rda")
```


### TODO - edit and save template OS reporting measure to extract exactly the variables I want

1) Date/Time
2) Zone HVAC Ideal Loads Air System XX: Zone Ideal Loads Zone Sensible XXXXXXX Energy [J]\(Hourly)
3) Zone Area (see OpenStudio Results section Zone Summary)
4) Zone's surfaces' boundary condition (Number of exposed surfaces) (see Envelope and Internal Load Breakdown Report section Surface Average Face Conduction Heat Gain/Loss)
5) Total Site EUI (OpenStudio Results)
6) Weather File (OS Results)
7) North Axis Angle (OS Results)
8) ASHRAE/CEC Climate Zone (OS Results)

<br><br><br>