---
title: "Process ReadVarsESO csv"
author: "Noah Klammer"
date: "3/15/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

## Clear global and report

```{r}
rm(list = ls())
gc()
```


# Import

## ESO timeseries

```{r import, message=FALSE, warning=FALSE}
eplusout <- readr::read_csv("eplusout.csv")
```


```{r include=FALSE}
# readr::spec(eplusout)
freq <- "null"
rows <- nrow(eplusout) 
if (rows==8760*4) {
  freq <- "15 minutes"
} else if (rows==8760) {
  freq <- "hourly"
} else if (rows==12) {
  freq <- "monthly"
} else {freq <- "could not determine"}
```
There are ``r ncol(eplusout)`` column variables in this file with names like ``r names(eplusout)[3]``, ``r names(eplusout)[50]``, and ``r names(eplusout)[100]``.

The frequency of this .eso file's timestep is ``r freq``.

## Ideal Air Loads to Zone mapping

```{r message=FALSE, warning=FALSE}
library(readr)
IdLoAiSy_Map <- read_csv("IdLoAiSy-Map.csv")
# char list of unconditioned spaces
unc_zones <- IdLoAiSy_Map$`Zone List`[is.na(IdLoAiSy_Map$`Ideal Air Loads System Number`)]
# drop unconditioned spaces
ILAS_map <- IdLoAiSy_Map %>%
  na.omit() %>%
  arrange(`Ideal Air Loads System Number`)
# note that some conditioned spaces don't have heat/cool loads
# in this model
```
Unconditioned zones in this model are ``r unc_zones``

## Area to Zone mapping

```{r message=FALSE, warning=FALSE}
Area_Map <- read_csv("ZoneFloorArea-Map.csv")
```


### Get all var names that match "Sensible" && "Zone Ideal Loads"
```{r}
# stringr::str_view_all(names(eplusout),"Zone\\sIdeal\\sLoads+.+Sensible")
ILAS_col <- grep("Zone\\sIdeal\\sLoads+.+Sensible", 
                 names(eplusout), value = TRUE) 
```

*Done* There are ``r length(ILAS_col)`` column variables in this subset.

### Sort
```{r}
# sort and fix "10" < "2" with stringr
sorted_list <- stringr::str_sort(ILAS_col, numeric = TRUE)
ILAS <- eplusout[sorted_list]

```


### Replace Air System Number with Zone name

`stringr::str_view_all` html snippet very helpful. As is stringr cheatsheet "strings.pdf".

```{r}
library(stringr)
# looks for any digit sets in colnames and
# replaces with zone string name mapping

# have to write which() indexing function
# and sapply over num vector
idx_n <- function(num) {
  which(num==ILAS_map$`Ideal Air Loads System Number`)
  }

s2nlist <- as.numeric(str_extract(colnames(ILAS),"[0-9]+"))
idx <- sapply(s2nlist,idx_n)

# str_replace() analogous to sub()
colnames(ILAS) =
stringr::str_replace(string = colnames(ILAS), 
                     pattern = "[0-9]+", 
                     replacement = ILAS_map$`Zone List`[idx])

# may have to do colname sort and re-index

# lessen characters in colnames
# ~Zone Ideal Loads Zone Sensible\\s~
colnames(ILAS) =
stringr::str_replace(colnames(ILAS), 
                     "\\:\\D{31}",
                     ": ")
```

### Normalize Loads by Floor Area

```{r}
# check here if var names ever change
# colnames(ILAS)

idx_s <- function(str) {
  which(str==Area_Map$`Zone List`)
  }

slist <- str_extract(colnames(ILAS),"(?<=SYSTEM\\s).+(?=\\:)")
idx2 <- sapply(slist,idx_s)
vec <- Area_Map$`Space Area [m2]`[idx2]

# apply normalization vector across matrix
ILAS <- sweep(ILAS, 2, vec, FUN = "/")

# change colnames to reflect metric
# **[J]** => [J/m^2]
colnames(ILAS) <- str_replace(colnames(ILAS),"(?<=\\[)J{1}","J/m^2")
```

### Inspect Zones and select only residential zones of interest

Residential zones are considered dwelling units, stairwells (don't know if they're connected vertically), and corridors above the first floor.

```{r}
res_list <- 
c(
grep("STAIRWELL_\\d", colnames(ILAS), value = TRUE),
grep("CORRIDOR_\\d", colnames(ILAS), value = TRUE),  
grep("BDRM", colnames(ILAS), value = TRUE)
)

sorted_list <- stringr::str_sort(res_list, numeric = TRUE)

ILAS <- ILAS[sorted_list]
```

### Add Date/Time back in
```{r warning=FALSE}
`Date/Time` <- eplusout$`Date/Time`
ILAS <- cbind(`Date/Time`,ILAS)

# make `Date/Time` string rownames
# this comes in handy for dataframe transpose
# drop hh:mm~:ss~
rownames(ILAS) <- str_replace(eplusout$`Date/Time`,".{3}$","")

# separate the date and time into cols month, day, hour, minute
ILAS <- ILAS %>%
  mutate(month = as.integer(substr(`Date/Time`, start = 0, stop = 2)),
         day = as.integer(substr(`Date/Time`, start = 4, stop = 5)),
         hour = as.integer(substr(`Date/Time`, start = 8, stop = 9)),
         `Date/Time` = as.integer(substr(`Date/Time`, start = 11, stop = 12))) %>%
  rename(minute = `Date/Time`)

sorted_list <- stringr::str_sort(colnames(ILAS), numeric = TRUE)

ILAS <- ILAS[sorted_list]
# numeric month var to month string
# ILAS <- transform(ILAS, month = month.abb[month])

```
*Done* The variables of interest have been selected and observations of NA have been removed. The dataframe now has ``r ncol(ILAS)`` columns and ``r nrow(ILAS)`` rows.

### Data QA/QC: remove observations with NA

```{r}
# remove NA observations
# remove minute col if subhourly data DNE
if( var(ILAS$minute)==0 | anyNA(ILAS) ) {
  ILAS <- ILAS %>% na.omit()
  ILAS <- select(ILAS,-minute)
  }
# remove the automatic row numbers
# rownames(ILAS) <- NULL
```


### Data QA/QC: zero variance

```{r include=FALSE}

sel_days_ILAS <- ILAS 

# visdat::vis_cor(sel_days_ILAS)
#=> "the standard deviation is zero"

# let's find which cols have zero variance
zv <- which(apply(sel_days_ILAS, 2, var) == 0)

z_var_zones <- str_subset(colnames(sel_days_ILAS)[zv],"ZONE")

# get zones that str match with "cooling"
c <- grep("*\\Dooling", z_var_zones, value = TRUE)
# get zones that str match with "heating"
h <- grep("*\\Deating", z_var_zones, value = TRUE)

# extracts zone name logic
c <- str_extract(c,"(?<=SYSTEM\\s).*(?=\\:)")
h <- str_extract(h,"(?<=SYSTEM\\s).*(?=\\:)")

# are there any zones with neither heating nor cooling?
# intersect(c,h)
#=> unconditioned zones

# remove the unc zones from
# `zero_var_zone_names` string list
z_var_zone_names <- unique( str_extract(z_var_zones,"(?<=SYSTEM\\s).*(?=\\:)") )
z_var_zone_names <- z_var_zone_names[!(z_var_zone_names %in% intersect(c,h))]
```

The longer we work with this data set, the more clear it is that many zones have zero variance. We see that ``r length(z_var_zones)`` out of ``r length(sel_days_ILAS)`` zones have zero variance for this temporal range.

We find that there are ``r length(c)`` zones with no cooling load and ``r length(h)`` zones with no heating load. We assert that `r intersect(c,h)` have neither cooling nor heating load. These zones are unconditioned spaces.

Removing the ``r length(intersect(c,h))`` unconditioned zones, we are left with ``r length(z_var_zone_names)`` that have either no heating or cooling load, depending on the climate file. These zones are `r z_var_zone_names`.

Naturally, for a correctly defined building energy model, few if any hours of a certain zone will have both heating and cooling. For possible future regression purposes, I will treat heating load as negative cooling load.

### Combine heating and cooling loads

```{r}
# filter for zone col vars only
slist <- str_subset(colnames(ILAS),"ZONE")
# get zone name from output variable name
slist_unique <- unique(str_extract(slist,"(?<=SYSTEM\\s).+(?=\\:)"))

# negate all variables that regexp match "Heating"
index <- str_which(colnames(ILAS),"Heating")
ILAS[,index] <- -ILAS[,index]
#=> RETURNS
any(ILAS < 0)

# this computation takes the two cols that
# share a zone name and adds them together
for (i in slist_unique) {
  index <- str_which(colnames(ILAS),i)
  ILAS[,index[1]] <- ILAS[,index[1]] + ILAS[,index[2]]
}
#=> RETURNS
any(ILAS < 0)

# reset df to have only cooling cols
# after above computation
ILAS <- ILAS %>%
  select(contains("Cooling"))
#=> RETURNS
any(ILAS < 0)
```




### Save as .Rda R data file

```{r}
save(ILAS,file = "ILAS.Rda")
```


### TODO - edit and save template OS reporting measure to extract exactly the variables I want

1) Date/Time
2) Zone HVAC Ideal Loads Air System XX: Zone Ideal Loads Zone Sensible XXXXXXX Energy [J]\\(Hourly)
3) Zone Area (see OpenStudio Results section Zone Summary)
4) Zone's surfaces' boundary condition (Number of exposed surfaces) (see Envelope and Internal Load Breakdown Report section Surface Average Face Conduction Heat Gain/Loss)
5) Total Site EUI (OpenStudio Results)
6) Weather File (OS Results)
7) North Axis Angle (OS Results)
8) ASHRAE/CEC Climate Zone (OS Results)

<br><br><br>